<!DOCTYPE html>
<html>
<head>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
    <h1>{{text}}</h1>
    <div id="playerContainer" style="display: none;">
        <div id="player"></div>
    </div>
    <form method="post" action="{% url 'quiz_movie' %}">
        {% csrf_token %}
        <button type="button" id="playButton" onclick="playVideo('play')">再生</button>
    </form>
    <!-- <button id="playButton" onclick="playVideo()">再生</button> -->
    <div id="endMessage" style="display: none;">アンケートに答えてください</div>

    <!-- クイズの解答フォーム -->
    <div id="quizForm">
        <h2>クイズに回答する</h2>
        <form method="post" action="{% url 'quiz_movie' %}">
            <label for="answer">回答：</label>
            <input type="text" id="answer" name="answer">
            <button type="button" id="submitButton" onclick="sendAnswer('answer')">送信</button>
        </form>
    </div>

    <script>
        var player;

        // YouTube APIがロードされたときに実行されるコールバック関数
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: '4t8JCicyYfc',  // 埋め込むYouTube動画のIDを指定
                playerVars: {
                    'controls': 0,  // コントロールを非表示にする
                    'disablekb': 1,  // キーボード操作を無効にする
                    'showinfo': 0,   // タイトルとアップロード者情報を非表示にする
                    'rel': 0,        // 関連動画を非表示にする
                    'autoplay': 0,   // 自動再生を有効にする
                    'playsinline': 1  // iOSデバイスでインライン再生を有効にする
                },
                events: {
                    'onReady': function(event) {
                        // event.target.playVideo();  // 動画を自動再生
                        // ページ初期表示時は非表示
                        var playerContainer = document.getElementById("playerContainer");
                        if (playerContainer) {
                            playerContainer.style.display = "none";
                        }
                    },
                    'onStateChange': function(event) {
                        if (event.data === YT.PlayerState.PAUSED) {
                            // 動画が一時停止されたときに再度再生
                            event.target.playVideo();
                        }
                        if (event.data === YT.PlayerState.ENDED) {
                            // 動画再生が終了したときにテキストを表示
                            var endMessage = document.getElementById("endMessage");
                            if (endMessage) {
                                endMessage.style.display = "block";
                            }
                            // 動画再生が終了したときに新しいタブで指定リンクを開く
                            window.open('https://www.library.metro.tokyo.lg.jp/', '_blank');
                        }
                    }
                }
            });
        }

        // 動画を再生する関数
        function playVideo(action) {
            // POSTリクエストを送信してボタンが押された時刻をデータベースに保存
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function() {
                if (xhr.status === 200) {
                    // ボタンが押されたら動画を表示して再生
                    var playerContainer = document.getElementById("playerContainer");
                    var playButton = document.getElementById("playButton");
                    if (playerContainer && playButton) {
                        playerContainer.style.display = "block";
                        playButton.style.display = "none";
                        player.playVideo();
                    }
                }
            };
            var data = JSON.stringify({ action: action });  // JSONデータとして識別子を送信
            xhr.send(data);
        }

        function sendAnswer(action) {
            // フォームの内容を取得
            var answer = document.getElementById("answer").value;
            // POSTリクエストを送信してデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            var data = JSON.stringify({ action: action, answer: answer });  // JSONデータとしてアクションと回答を送信
            xhr.send(data);
        }

    </script>
</body>
</html>

