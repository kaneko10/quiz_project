<!DOCTYPE html>
<html>
<head>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <style>
        #webcam {
            height: 40vh;
        }

        #canvas {
            height: 40vh;
        }

        #webcameraContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; /* ビューポートの高さいっぱいに要素を広げる */
            text-align: center;
        }

        #webcameraContainer > * {
            margin: 10px; /* 要素間の余白を設定（適宜調整してください） */
        }

        #playerContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 40vh; /* ビューポートの高さいっぱいに要素を広げる */
            text-align: center;
        }

        #quizForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #playVideoForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
        }

        .progress-bar {
            width: 0;
            height: 30px;
            background-color: #007bff;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>

<body>
    <h1>{{text}}</h1>

    <!-- <video id="local" playsinline autoplay muted></video>
    <video id="recorded" playsinline loop></video> -->

    <!-- <div>
      <button id="start">映像を取得する</button>
      <button id="record" disabled>録画開始</button>
      <button id="play" disabled>再生</button>
      <button id="download" disabled>ダウンロード</button>
    </div> -->

    <div id="clock"></div>

    <video id="webcam" autoplay></video>
    <canvas id="canvas"></canvas>

    <!-- webカメラ -->

    <!-- クイズ動画再生エリア -->
    <div id="playerContainer" style="display: none;">
        <!-- <div id="player"></div> -->
    </div>
    <form method="post" action="{% url 'quiz_movie' person_id=person_id %}" id="playVideoForm">
        {% csrf_token %}
        <!-- 例題の動画再生ボタン -->
        <button type="button" id="exPlayButton" style="display: block;" onclick="playingVideo('play', true, true)">例題</button>
        <!-- 1つ目の動画再生ボタン -->
        <button type="button" id="playButton" style="display: none;" onclick="playingVideo('play', false, true)">開始</button>
    </form>

    <!-- webカメラ -->
    <div id="webcameraContainer">
        <div id="image_area">
            <img src="/quiz/video_feed/" width="810" height="540"/>
        </div>
        <!-- <a href="/quiz/stop_recording/" download="video.mp4" id="downloadLink">動画をダウンロード</a> -->
    </div>

    <!-- クイズの回答フォーム -->
    <div id="quizForm" style="display: none;">
        <h2>クイズに回答する</h2>
        <form method="post" action="{% url 'quiz_movie' person_id=person_id %}">
            <label for="answer">回答：</label>
            <input type="text" id="answer" name="answer">
            <button type="button" id="submitButton" onclick="sendAnswer('answer')">送信</button>
        </form>
    </div>

    <!-- アンケートフォーム -->
    <div id="questionnaire" style="display: none;">
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <p>アンケートに答えてください</p>
        <!-- <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdJagml4y_YcnofXxFxwgn8mGsZ7I3jRXAo4j65MlSKR_uP6w/viewform?embedded=true" width="640" height="653" frameborder="0" marginheight="0" marginwidth="0">読み込んでいます…</iframe> -->
        <form method="post" action="{% url 'quiz_movie' person_id=person_id %}">
            <!-- 質問1 -->
            <h3>質問1：感想</h3>
            <label for="q1_delight">
                <input type="radio" name="q1" id="q1_delight" value="delight"> Delight
            </label>
            <label for="q1_boredom">
                <input type="radio" name="q1" id="q1_boredom" value="boredom"> Boredom
            </label>
            <label for="q1_confused">
                <input type="radio" name="q1" id="q1_confused" value="confused"> Confused
            </label>
            <label for="q1_frustration">
                <input type="radio" name="q1" id="q1_frustration" value="frustration"> Frustration
            </label>
            <label for="q1_concentration">
                <input type="radio" name="q1" id="q1_concentration" value="concentration"> Concentration
            </label>
            <label for="q1_neutral">
                <input type="radio" name="q1" id="q1_neutral" value="neutral"> Neutral
            </label>
    
            <!-- 質問2 -->
            <h3>質問2：難易度</h3>
            <label for="q2_seen_difficulty">
                問題を見たとき：
                <label for="q2_que_very_easy">
                    <input type="radio" name="q2_que" id="q2_que_very_easy" value="very_easy"> 非常に簡単
                </label>
                <label for="q2_que_easy">
                    <input type="radio" name="q2_que" id="q2_que_easy" value="easy"> 簡単
                </label>
                <label for="q2_que_normal">
                    <input type="radio" name="q2_que" id="q2_que_normal" value="normal"> ふつう
                </label>
                <label for="q2_que_hard">
                    <input type="radio" name="q2_que" id="q2_que_hard" value="hard"> 難しい
                </label>
                <label for="q2_que_very_hard">
                    <input type="radio" name="q2_que" id="q2_que_very_hard" value="very_hard"> 非常に難しい
                </label>
            </label>
            <label for="q2_seen_difficulty">
                <p></p>
                答えを見たとき：
                <label for="q2_ans_very_easy">
                    <input type="radio" name="q2_ans" id="q2_ans_very_easy" value="very_easy"> 非常に簡単
                </label>
                <label for="q2_ans_easy">
                    <input type="radio" name="q2_ans" id="q2_ans_easy" value="easy"> 簡単
                </label>
                <label for="q2_ans_normal">
                    <input type="radio" name="q2_ans" id="q2_ans_normal" value="normal"> ふつう
                </label>
                <label for="q2_ans_hard">
                    <input type="radio" name="q2_ans" id="q2_ans_hard" value="hard"> 難しい
                </label>
                <label for="q2_ans_very_hard">
                    <input type="radio" name="q2_ans" id="q2_ans_very_hard" value="very_hard"> 非常に難しい
                </label>
            </label>
    
            <!-- 質問3 -->
            <h3>質問3：ヒントは役だったか？</h3>
            <label for="q3_helpful">
                <input type="radio" name="q3" id="q3_helpful" value="helpful"> 強くそう思う
            </label>
            <label for="q3_somewhat_helpful">
                <input type="radio" name="q3" id="q3_somewhat_helpful" value="somewhat_helpful"> そう思う
            </label>
            <label for="q3_neutral">
                <input type="radio" name="q3" id="q3_neutral" value="neutral"> どちらとも言えない
            </label>
            <label for="q3_not_helpful">
                <input type="radio" name="q3" id="q3_not_helpful" value="not_helpful"> そう思わない
            </label>
            <label for="q3_not_at_all_helpful">
                <input type="radio" name="q3" id="q3_not_at_all_helpful" value="not_at_all_helpful"> まったくそう思わない
            </label>
    
            <!-- 質問4 -->
            <h3>質問4：クイズ開始時を0として現在の疲労度を選択してください。</h3>
            <label for="q4_zero">
                <input type="radio" name="q4" id="q4_zero" value="zero"> 0
            </label>
            <label for="q4_one">
                <input type="radio" name="q4" id="q4_one" value="one"> 1
            </label>
            <label for="q4_two">
                <input type="radio" name="q4" id="q4_two" value="two"> 2
            </label>
            <label for="q4_three">
                <input type="radio" name="q4" id="q4_three" value="three"> 3
            </label>
            <label for="q4_four">
                <input type="radio" name="q4" id="q4_four" value="four"> 4
            </label>
        </form>
    </div>

    <script>
        const start = (new Date()).getTime();
        var now;

        function updateClock() {
            now = (new Date()).getTime();
            const passed = now - start;


            const clockElement = document.getElementById('clock');
            clockElement.textContent = passed;
        }

        // 初回表示
        updateClock();

        // 10msごとに更新
        setInterval(updateClock, 10);


        // const localVideo = document.getElementById("local");
        // const canvas = document.createElement("canvas");
        // const ctx = canvas.getContext("2d");

        
        const webcam = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const frameArray = [];

        // ウェブカメラから映像をキャプチャ
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                webcam.srcObject = stream;
            })
            .catch(error => {
                console.error('Error accessing webcam:', error);
            });

        // タイムスタンプを描画
        function drawTimestamp() {
            const timestamp = now - start;
            
            ctx.font = '20px Arial';
            ctx.fillStyle = 'black';
            ctx.fillText(timestamp, 10, 30);
        }

        // キャンバスに映像を描画
        function captureFrame() {
            ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
            drawTimestamp();

            const frameData = canvas.toDataURL('image/png');  // フレームデータをBase64エンコード
            frameArray.push(frameData);  // フレームデータを配列に格納

            // 次のフレームをキャプチャ
            requestAnimationFrame(captureFrame);
        }

        // 映像が読み込まれたらキャプチャ開始
        webcam.addEventListener('play', () => {
            canvas.width = webcam.videoWidth;
            canvas.height = webcam.videoHeight;
            captureFrame();
        });

        function sendFrameData() {
            // POSTリクエストを送信して動画の順番データデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
            };

            frames = [];

            console.log("frameArraySize: " + frameArray.length);

            for (let i = 0; i < 3; i++) {
                frames.push(frameArray[i]);
            }

            var context = { 
                action: 'webcamera', 
                frames: frames,
            };
            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);
        }

        var player;

        var quiz_movie_ids;
        var quizIndex = 0;
        var currentMovieID = "";
        var person_id = "";

        const questionnaireTime = 3000; // (ms)
        const breakTime = 3000  // 問題間の休憩時間

        var isPlaying = false;
        var isFirstPaused = true;

        // YouTube APIがロードされたときに実行されるコールバック関数
        function onYouTubeIframeAPIReady() {
            // player オブジェクトを生成
            console.log("YouTube APIが初期化されました。")

            // 現在のURLを取得
            var currentURL = window.location.href;

            // 正規表現を使用してperson_idの値を抽出
            var regex = /person_id=([^&]+)/;
            var match = currentURL.match(regex);

            // person_idの値を取得
            var personId = match && match[1];
            person_id = personId;
            // console.log("person_idの値は: " + person_id);

            createNewPlayer(true, true);
        }

        // ランダムな順番にした動画IDを生成
        function makeQuizMovieIDs() {
            // 例題
            const quiz_movie_ex = 'ubgKp0MoNHE' // 仮置き（蚊）
            // const quiz_movie_ex = '4t8JCicyYfc' // 仮置き（クイズノック）

            // 謎解き
            const quiz_movie_mystery = [
                'JzfDo389ZaY',  // アーモンド
                'W1yGj2dwItQ',  // 赤身
                'BoBzFke_Cbw',  // いのしし
                // 'zLm_ILEKJ7A',  // チューイングガム　まだ
                // 'CMOCBTYa8f0',  // マスカット　まだ
                // 'wqHQJsGpgV0',  // カッパ　まだ
                // 'IjdnudDMxnY',  // 太陽系　まだ
                // '4t8JCicyYfc',  // クイズノック
                // 'qPHSalN8k0I',  // クイズノック
                // 'Ns8-e-5Ll6c',  // クイズノック
            ];

            // なぞなぞ
            const quiz_movie_riddle = [
                'ubgKp0MoNHE',  // 蚊  
                'SMykdWzApTg',  // いくら
                'Av8mrPXsWkY',  // ソフトボール
                'zjphDXhTUI8',  // 不眠
                'Bk66yWgQACk',  // 森
                'ga6PY-7y0VE',  // 視覚
                '5eWLkYdCpYc',  // 119
                // 'aUR455d8oek',  // バトル　まだ
                // '4t8JCicyYfc',  // クイズノック
                // 'qPHSalN8k0I',  // クイズノック
                // 'Ns8-e-5Ll6c',  // クイズノック
            ];

            var quiz_movie_ids = [];

            quiz_movie_ids.push(quiz_movie_ex);

            const randoms_mystery = makeRandomArray(0, quiz_movie_mystery.length - 1);
            for (i = 0; i < randoms_mystery.length; i++) {
                quiz_movie_ids.push(quiz_movie_mystery[randoms_mystery[i]]);
            }

            const randoms_riddle = makeRandomArray(0, quiz_movie_riddle.length - 1);
            for (i = 0; i < randoms_riddle.length; i++) {
                quiz_movie_ids.push(quiz_movie_riddle[randoms_riddle[i]]);
            }

            // POSTリクエストを送信して動画の順番データデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            // 動画のIDリストから例題のIDを除いたリストを生成
            // console.log("削除前： " + quiz_movie_ids);
            var copy_movie_ids = JSON.parse(JSON.stringify(quiz_movie_ids));
            copy_movie_ids.shift();
            // console.log("削除後： " + copy_movie_ids);

            var context = { 
                action: 'quiz_order', 
                randoms_mystery: randoms_mystery,
                randoms_riddle: randoms_riddle,
                movie_ids: copy_movie_ids, 
                person_id: person_id,
            };
            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);

            return quiz_movie_ids;
        }

        function makeRandomArray(min, max) {
            var randoms = [];
            for(i = min; i <= max; i++){
                while(true){
                    var tmp = randomInt(min, max);
                    if(!randoms.includes(tmp)){
                        randoms.push(tmp);
                        break;
                    }
                }
            }
            console.log("randoms: " + randoms);
            return randoms;
        }

        function randomInt(min, max){
            return Math.floor( Math.random() * (max - min + 1)) + min;
        }

        // 動画再生が終了したときに id=player の div 要素を削除する関数
        function removePlayer() {
            let playerContainer = document.getElementById("playerContainer");
            let playerDiv =  document.getElementById("player");
            if (playerContainer) {
                playerContainer.removeChild(playerDiv);
            }
        }

        // 新しいプレーヤーを生成する関数
        // exPlay -> true：例題動画の再生
        // firstPlay -> true : 例題または本番の1回目の再生
        function createNewPlayer(exPlay, firstPlay) {
            var playerContainer = document.getElementById("playerContainer");
            var playerDiv = document.createElement("div");
            playerDiv.id = "player";
            playerContainer.appendChild(playerDiv);

            if (player) {
                // 現在のプレーヤーが存在する場合、削除します
                player.destroy();
                // console.log("destroy player")
            }

            // 動画のIDリストを生成（例題の問題の時）
            if (exPlay) {
                quiz_movie_ids = makeQuizMovieIDs();
                console.log("quiz_movie_ids: " + quiz_movie_ids);
            }

            // console.log("videoID: " + quizIndex)
            currentMovieID = quiz_movie_ids[quizIndex]
            player = new YT.Player('player', {
                videoId: currentMovieID,  // 埋め込むYouTube動画のIDを指定
                playerVars: {
                    // 'controls': 0,  // コントロールを非表示にする
                    'disablekb': 1,  // キーボード操作を無効にする
                    'showinfo': 0,   // タイトルとアップロード者情報を非表示にする
                    'rel': 0,        // 関連動画を非表示にする
                    'autoplay': 0,   // 自動再生を有効にする
                    'playsinline': 1  // iOSデバイスでインライン再生を有効にする
                },
                events: {
                    'onReady': function(event) {
                        // event.target.playVideo();  // 動画を自動再生
                        if (!firstPlay) {
                            event.target.playVideo(); // 自動再生

                            console.log("動画の再生を開始：onReady")
                        } else {
                            console.log("プレーヤーの準備が完了しました。")
                        }
                    },
                    'onStateChange': function(event) {
                        if (event.data == YT.PlayerState.PLAYING) {
                            // PLAYINGだと、本当の再生開始時刻より若干遅い
                            const timestamp = now - start;
                            console.log("再生時刻: " + timestamp);

                            if (isFirstPaused) {
                                var interval = setInterval(function() {
                                    const currentTime = event.target.getCurrentTime();
                                    if (currentTime >= 1) {
                                        event.target.pauseVideo();
                                        clearInterval(interval); // タイマーを停止
                                        console.log(`現在の再生時間: ${currentTime}秒`);
                                    }
                                }, 5); // 5msごとに更新
                            }

                            // 動画クリックするごとに毎回実行される
                            console.log("動画の再生を開始：PLAYING");

                            if (!isPlaying) {
                                // 動画の再生時刻の保存をサーバーに要求
                                orderSaveDate('play', timestamp)
                                isPlaying = true;
                            }

                        } else if (event.data === YT.PlayerState.PAUSED) {
                            // 動画が一時停止されたときに再度再生
                            // event.target.playVideo();

                            if (isFirstPaused) {
                                setTimeout(function() {
                                    event.target.playVideo();
                                    // ここの再生時刻の方が真の値に近い、けどまだ若干遅い
                                    const timestamp = now - start;
                                    console.log("再生時刻(PAUSED): " + timestamp);
                                }, 1000);
                                isFirstPaused = false;
                            }
                        } else if (event.data === YT.PlayerState.ENDED) {
                            console.log("動画の再生が終了しました");

                            const timestamp = now - start;
                            console.log("終了時刻： " + timestamp);

                            // 動画の再生終了時刻の保存をサーバーに要求
                            orderSaveDate('ended', timestamp)
                            isPlaying = false;
                            isFirstPaused = true;

                            // 動画を非表示
                            removePlayer(); // id=player の div 要素を削除
                            var playerContainer = document.getElementById("playerContainer");
                            if (playerContainer) {
                                playerContainer.style.display = "none";
                            }

                            // 回答フォームを非表示
                            var quizForm = document.getElementById("quizForm");
                            if (quizForm) {
                                quizForm.style.display = "none";
                            }

                            // アンケートを表示
                            resetRadioButtons();
                            var questionnaire = document.getElementById("questionnaire");
                            if (questionnaire) {
                                questionnaire.style.display = "block";
                            }

                            // アンケートのプログレスバーを表示
                            var durationInSeconds = questionnaireTime / 1000; // 秒数を変数で指定
                            var progress = 0; // 現在の進捗（0%から100%）
                            var progressBar = document.getElementById("progress-bar");

                            var interval = setInterval(function() {
                                progress += 1;
                                progressBar.style.width = (progress / durationInSeconds * 100) + "%";
                                progressBar.textContent = Math.round((progress / durationInSeconds) * 100) + "%";

                                if (progress >= durationInSeconds) {
                                    clearInterval(interval); // タイマーを停止
                                }
                            }, 1000); // 1秒ごとに更新
                            // 動画再生が終了したときに新しいタブで指定リンクを開く
                            // window.open('https://docs.google.com/forms/d/e/1FAIpQLSdnFFQIqY782gk1XMCYFhWKdOMsMFPaYdxABGaFscjp2FaZyg/viewform?usp=sf_link', '_blank');

                            setTimeout(function() {
                                console.log(`アンケート：${questionnaireTime / 1000}秒経過しました`);
                                // アンケートを送信
                                submitForm('questionnaire');
                                // // 次の動画を再生
                                // playNextVideo('play');
                                console.log("アンケートを送信完了");
                            }, questionnaireTime);

                            setTimeout(function() {
                                console.log(`休憩：${breakTime / 1000}秒経過しました`);
                                // 次の動画を再生
                                playNextVideo('play');
                            }, breakTime + questionnaireTime);
                        }
                    }
                }
            });
        }        

        // 動画を再生する関数
        function playingVideo(action, exPlay, firstPlay) {
            // 例題動画の再生
            if (exPlay) {
                // webカメラの映像を非表示
                // var webCamera = document.getElementById("webcameraContainer");
                // if (webCamera) {
                //     webCamera.style.display = "none";
                // }

                // 例題ボタンを非表示
                var exPlayButton = document.getElementById("exPlayButton");
                if (exPlayButton) {
                    exPlayButton.style.display = "none";
                }
            }

            // 本番の動画1回目の再生
            if (firstPlay) {
                // 再生ボタンを非表示
                var playButton = document.getElementById("playButton");
                if (playButton) {
                    playButton.style.display = "none";
                }
            }

            if (quizIndex != 0) {
                if (player) {
                    player = null
                }
                if(player == null) {
                    // console.log("player is null")
                    // player オブジェクトが存在しない場合、新たに生成
                    if (exPlay) {
                        createNewPlayer(false, true);
                    } else {
                        createNewPlayer(false, false);
                    }
                }
            }

            // 回答フォームを表示
            var quizForm = document.getElementById("quizForm");
            if (quizForm) {
                quizForm.style.display = "block";
            }

            // 動画を表示して再生
            var playerContainer = document.getElementById("playerContainer");
            // var playButton = document.getElementById("playButton");
            if (playerContainer) {
                playerContainer.style.display = "block";

                if(player) {
                    // console.log("playVideo")
                    player.playVideo();
                }         
            }
        }

        function playNextVideo(action) {
            if (quizIndex == 1) {
                // 例題の次の動画
                // 再生ボタンを表示
                // 再生ボタンを非表示
                var playButton = document.getElementById("playButton");
                if (playButton) {
                    playButton.style.display = "block";
                }

            } else if (quizIndex < quiz_movie_ids.length) {
                console.log("次の動画を再生");
                playingVideo('play', false, false);
            } else {
                // webカメラの映像を表示
                var webCamera = document.getElementById("webcameraContainer");
                if (webCamera) {
                    webCamera.style.display = "block";
                }

                // ダウンロードリンクを作成
                var downloadLink = document.createElement("a");
                downloadLink.href = "/quiz/stop_recording/";
                downloadLink.download = "video.mp4";
                downloadLink.textContent = "動画をダウンロード";

                var webcameraContainer = document.getElementById("webcameraContainer");

                if (webcameraContainer) {
                    webcameraContainer.appendChild(downloadLink);
                }
            }
            // console.log("次の動画を再生完了");
        }

        function orderSaveDate(action, timeString) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (action == 'play') {
                        console.log("再生開始時刻の保存が成功しました");
                    } else if(action == 'ended') {
                        console.log("再生終了時刻の保存が成功しました");

                        // quizIndexの値をインクリメント
                        var responseData = JSON.parse(xhr.responseText);
                        quizIndex = responseData.quizIndex;
                        // console.log("Received quizIndex: " + quizIndex);
                    }
                }
            };
            var context = { 
                action: action, 
                quizIndex: quizIndex,
                person_id: person_id,
                movie_id: currentMovieID,
            };
            var data = JSON.stringify(context);  // JSONデータとして識別子を送信
            xhr.send(data);
        }

        function sendAnswer(action) {
            // フォームの内容を取得
            var answer = document.getElementById("answer").value;
            // POSTリクエストを送信してデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie'  person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            context = {
                action: action,
                answer: answer,
                person_id: person_id,
                movie_id: currentMovieID,
            }

            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);
        }

        // フォーム送信
        function submitForm(action) {
            console.log("アンケートを送信");
            // アンケートの回答を取得
            var context = {
                action: action,
                q1: getRadioButtonValue("q1"),
                q2_que: getRadioButtonValue("q2_que"),
                q2_ans: getRadioButtonValue("q2_ans"),
                q3: getRadioButtonValue("q3"),
                q4: getRadioButtonValue("q4"),
                person_id: person_id,
                movie_id: currentMovieID,
            };

            // POSTリクエストを送信してデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);

            // プログレスバーをリセット
            var progressBar = document.getElementById("progress-bar");
            progress = 0; // 進捗をリセット
            progressBar.style.width = "0%"; // プログレスバーの幅を初期化
            progressBar.textContent = "0%";

            // アンケートを非表示
            var questionnaire = document.getElementById("questionnaire");
            questionnaire.style.display = "none";
        }

        function getRadioButtonValue(name) {
            var radioButtons = document.querySelectorAll(`input[name=${name}]`);
            var selectedValue;

            for (var i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                    selectedValue = radioButtons[i].value;
                    break;
                }
            }
            // console.log("選択されたラジオボタンの値: " + selectedValue);

            if (selectedValue == undefined) {
                selectedValue = "undefined";
            }

            return selectedValue;
        }

        function resetRadioButtons() {
            // Q1
            resetRadioButtonCheck("q1_delight");
            resetRadioButtonCheck("q1_boredom");
            resetRadioButtonCheck("q1_confused");
            resetRadioButtonCheck("q1_frustration");
            resetRadioButtonCheck("q1_concentration");
            resetRadioButtonCheck("q1_neutral");

            // Q2-1
            resetRadioButtonCheck("q2_que_very_easy");
            resetRadioButtonCheck("q2_que_easy");
            resetRadioButtonCheck("q2_que_normal");
            resetRadioButtonCheck("q2_que_hard");
            resetRadioButtonCheck("q2_que_very_hard");
            // Q2-2
            resetRadioButtonCheck("q2_ans_very_easy");
            resetRadioButtonCheck("q2_ans_easy");
            resetRadioButtonCheck("q2_ans_normal");
            resetRadioButtonCheck("q2_ans_hard");
            resetRadioButtonCheck("q2_ans_very_hard");
    
            // Q3
            resetRadioButtonCheck("q3_helpful");
            resetRadioButtonCheck("q3_somewhat_helpful");
            resetRadioButtonCheck("q3_neutral");
            resetRadioButtonCheck("q3_not_helpful");
            resetRadioButtonCheck("q3_not_at_all_helpful");

            // Q4
            resetRadioButtonCheck("q4_zero");
            resetRadioButtonCheck("q4_one");
            resetRadioButtonCheck("q4_two");
            resetRadioButtonCheck("q4_three");
            resetRadioButtonCheck("q4_four");
        }

        function resetRadioButtonCheck(id) {
            const radioButton = document.getElementById(id);
            radioButton.checked = false;
        }

    </script>
</body>
</html>

