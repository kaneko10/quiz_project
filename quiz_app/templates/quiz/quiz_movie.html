<!DOCTYPE html>
<html>
<head>
    <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
    <h1>{{text}}</h1>
    <div id="playerContainer" style="display: none;">
        <div id="player"></div>
    </div>
    <form method="post" action="{% url 'quiz_movie' %}">
        {% csrf_token %}
        <button type="button" id="playButton" onclick="playVideo()">再生</button>
    </form>
    <!-- <button id="playButton" onclick="playVideo()">再生</button> -->
    <div id="endMessage" style="display: none;">アンケートに答えてください</div>

    <script>
        var player;

        // YouTube APIがロードされたときに実行されるコールバック関数
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                videoId: '4t8JCicyYfc',  // 埋め込むYouTube動画のIDを指定
                playerVars: {
                    'controls': 0,  // コントロールを非表示にする
                    'disablekb': 1,  // キーボード操作を無効にする
                    'showinfo': 0,   // タイトルとアップロード者情報を非表示にする
                    'rel': 0,        // 関連動画を非表示にする
                    'autoplay': 0,   // 自動再生を有効にする
                    'playsinline': 1  // iOSデバイスでインライン再生を有効にする
                },
                events: {
                    'onReady': function(event) {
                        // event.target.playVideo();  // 動画を自動再生
                        // ページ初期表示時は非表示
                        var playerContainer = document.getElementById("playerContainer");
                        if (playerContainer) {
                            playerContainer.style.display = "none";
                        }
                    },
                    'onStateChange': function(event) {
                        if (event.data === YT.PlayerState.PAUSED) {
                            // 動画が一時停止されたときに再度再生
                            event.target.playVideo();
                        }
                        if (event.data === YT.PlayerState.ENDED) {
                            // 動画再生が終了したときにテキストを表示
                            var endMessage = document.getElementById("endMessage");
                            if (endMessage) {
                                endMessage.style.display = "block";
                            }
                        }
                    }
                }
            });
        }

        // 動画を再生する関数
        function playVideo() {
            // POSTリクエストを送信してボタンが押された時刻をデータベースに保存
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // ボタンが押されたら動画を表示して再生
                    var playerContainer = document.getElementById("playerContainer");
                    var playButton = document.getElementById("playButton");
                    if (playerContainer && playButton) {
                        playerContainer.style.display = "block";
                        playButton.style.display = "none";
                        player.playVideo();
                    }
                }
            };
            xhr.send();
        }
    </script>
</body>
</html>

