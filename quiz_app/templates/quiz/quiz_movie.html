<!DOCTYPE html>
<html>
<head>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <style>
        #webcameraContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh; /* ビューポートの高さいっぱいに要素を広げる */
            text-align: center;
        }

        #webcameraContainer > * {
            margin: 10px; /* 要素間の余白を設定（適宜調整してください） */
        }

        #playerContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 50vh; /* ビューポートの高さいっぱいに要素を広げる */
            text-align: center;
        }

        #quizForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #playVideoForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
        }

        .progress-bar {
            width: 0;
            height: 30px;
            background-color: #007bff;
            text-align: center;
            line-height: 30px;
            color: white;
        }
    </style>
</head>

<body>
    <h1>{{text}}</h1>

    <video id="local" playsinline autoplay muted></video>
    <video id="recorded" playsinline loop></video>

    <div>
      <button id="start">映像を取得する</button>
      <button id="record" disabled>録画開始</button>
      <button id="play" disabled>再生</button>
      <button id="download" disabled>ダウンロード</button>
    </div>

    <!-- <video id="webcam" autoplay></video> -->
    <canvas id="canvas"></canvas>

    <!-- <button type="button" onclick="sendFrameData()">映像送信</button> -->
    <!-- <button type="button" onclick="downloadZip()">zipダウンロード</button> -->
    <!-- <a href="#" id="downloadLink">zipダウンロード</a>s -->


    <!-- <video id="videoElement" autoplay playsinline></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <button id="startRecording">録画開始</button>
    <button id="stopRecording">録画停止</button>
    <a id="downloadLink" style="display: none;">ダウンロード</a> -->


    <!-- webカメラ -->

    <!-- クイズ動画再生エリア -->
    <div id="playerContainer" style="display: none;">
        <!-- <div id="player"></div> -->
    </div>
    <form method="post" action="{% url 'quiz_movie' person_id=person_id %}" id="playVideoForm">
        {% csrf_token %}
        <!-- 例題の動画再生ボタン -->
        <button type="button" id="exPlayButton" style="display: block;" onclick="playVideo('play', true, true)">例題</button>
        <!-- 1つ目の動画再生ボタン -->
        <button type="button" id="playButton" style="display: none;" onclick="playVideo('play', false, true)">開始</button>
    </form>

    <!-- webカメラ -->
    <div id="webcameraContainer">
        <div id="image_area">
            <img src="/quiz/video_feed/" width="810" height="540"/>
        </div>
        <!-- <a href="/quiz/stop_recording/" download="video.mp4" id="downloadLink">動画をダウンロード</a> -->
    </div>

    <!-- クイズの回答フォーム -->
    <div id="quizForm" style="display: none;">
        <h2>クイズに回答する</h2>
        <form method="post" action="{% url 'quiz_movie' person_id=person_id %}">
            <label for="answer">回答：</label>
            <input type="text" id="answer" name="answer">
            <button type="button" id="submitButton" onclick="sendAnswer('answer')">送信</button>
        </form>
    </div>

    <!-- アンケートフォーム -->
    <div id="questionnaire" style="display: none;">
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <p>アンケートに答えてください</p>
        <!-- <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdJagml4y_YcnofXxFxwgn8mGsZ7I3jRXAo4j65MlSKR_uP6w/viewform?embedded=true" width="640" height="653" frameborder="0" marginheight="0" marginwidth="0">読み込んでいます…</iframe> -->
        <form method="post" action="{% url 'quiz_movie' person_id=person_id %}">
            <!-- 質問1 -->
            <h3>質問1：感想</h3>
            <label for="q1_delight">
                <input type="radio" name="q1" id="q1_delight" value="delight"> Delight
            </label>
            <label for="q1_boredom">
                <input type="radio" name="q1" id="q1_boredom" value="boredom"> Boredom
            </label>
            <label for="q1_confused">
                <input type="radio" name="q1" id="q1_confused" value="confused"> Confused
            </label>
            <label for="q1_frustration">
                <input type="radio" name="q1" id="q1_frustration" value="frustration"> Frustration
            </label>
            <label for="q1_concentration">
                <input type="radio" name="q1" id="q1_concentration" value="concentration"> Concentration
            </label>
            <label for="q1_neutral">
                <input type="radio" name="q1" id="q1_neutral" value="neutral"> Neutral
            </label>
    
            <!-- 質問2 -->
            <h3>質問2：難易度</h3>
            <label for="q2_seen_difficulty">
                問題を見たとき：
                <label for="q2_que_very_easy">
                    <input type="radio" name="q2_que" id="q2_que_very_easy" value="very_easy"> 非常に簡単
                </label>
                <label for="q2_que_easy">
                    <input type="radio" name="q2_que" id="q2_que_easy" value="easy"> 簡単
                </label>
                <label for="q2_que_normal">
                    <input type="radio" name="q2_que" id="q2_que_normal" value="normal"> ふつう
                </label>
                <label for="q2_que_hard">
                    <input type="radio" name="q2_que" id="q2_que_hard" value="hard"> 難しい
                </label>
                <label for="q2_que_very_hard">
                    <input type="radio" name="q2_que" id="q2_que_very_hard" value="very_hard"> 非常に難しい
                </label>
            </label>
            <label for="q2_seen_difficulty">
                <p></p>
                答えを見たとき：
                <label for="q2_ans_very_easy">
                    <input type="radio" name="q2_ans" id="q2_ans_very_easy" value="very_easy"> 非常に簡単
                </label>
                <label for="q2_ans_easy">
                    <input type="radio" name="q2_ans" id="q2_ans_easy" value="easy"> 簡単
                </label>
                <label for="q2_ans_normal">
                    <input type="radio" name="q2_ans" id="q2_ans_normal" value="normal"> ふつう
                </label>
                <label for="q2_ans_hard">
                    <input type="radio" name="q2_ans" id="q2_ans_hard" value="hard"> 難しい
                </label>
                <label for="q2_ans_very_hard">
                    <input type="radio" name="q2_ans" id="q2_ans_very_hard" value="very_hard"> 非常に難しい
                </label>
            </label>
    
            <!-- 質問3 -->
            <h3>質問3：ヒントは役だったか？</h3>
            <label for="q3_helpful">
                <input type="radio" name="q3" id="q3_helpful" value="helpful"> 強くそう思う
            </label>
            <label for="q3_somewhat_helpful">
                <input type="radio" name="q3" id="q3_somewhat_helpful" value="somewhat_helpful"> そう思う
            </label>
            <label for="q3_neutral">
                <input type="radio" name="q3" id="q3_neutral" value="neutral"> どちらとも言えない
            </label>
            <label for="q3_not_helpful">
                <input type="radio" name="q3" id="q3_not_helpful" value="not_helpful"> そう思わない
            </label>
            <label for="q3_not_at_all_helpful">
                <input type="radio" name="q3" id="q3_not_at_all_helpful" value="not_at_all_helpful"> まったくそう思わない
            </label>
    
            <!-- 質問4 -->
            <h3>質問4：クイズ開始時を0として現在の疲労度を選択してください。</h3>
            <label for="q4_zero">
                <input type="radio" name="q4" id="q4_zero" value="zero"> 0
            </label>
            <label for="q4_one">
                <input type="radio" name="q4" id="q4_one" value="one"> 1
            </label>
            <label for="q4_two">
                <input type="radio" name="q4" id="q4_two" value="two"> 2
            </label>
            <label for="q4_three">
                <input type="radio" name="q4" id="q4_three" value="three"> 3
            </label>
            <label for="q4_four">
                <input type="radio" name="q4" id="q4_four" value="four"> 4
            </label>
        </form>
    </div>

    <script>
        const localVideo = document.getElementById("local");
const canvas = document.createElement("canvas");
const ctx = canvas.getContext("2d");
const recordedVideo = document.getElementById("recorded");
const startBtn = document.getElementById("start");
const recordBtn = document.getElementById("record");
const playBtn = document.getElementById("play");
const downloadBtn = document.getElementById("download");
let mediaRecorder;
let recordedBlobs;

function getLocalMediaStream(mediaStream) {
  recordBtn.disabled = false;
  const localStream = mediaStream;
  localVideo.srcObject = mediaStream;
  window.stream = mediaStream;
}

function handleLocalMediaStreamError(error) {
  console.log(`navigator.getUserMedia error: ${error}`);
}

function handleDataAvailable(event) {
  if (event.data && event.data.size > 0) {
    recordedBlobs.push(event.data);
  }
}

function startRecording() {
  recordedBlobs = [];
  const options = { mimeType: "video/webm;codecs=vp9" };

  try {
    mediaRecorder = new MediaRecorder(window.stream, options);
  } catch (error) {
    console.log(`Exception while creating MediaRecorder: ${error}`);
    return;
  }

  console.log("Created MediaRecorder", mediaRecorder);
  recordBtn.textContent = "録画停止";
  playBtn.disabled = true;
  downloadBtn.disabled = true;

  mediaRecorder.onstop = event => {
    console.log("Recorder stopped: ", event);
  };

  mediaRecorder.ondataavailable = handleDataAvailable;
  mediaRecorder.start(10);
  console.log("MediaRecorder started", mediaRecorder);
}

function stopRecording() {
  mediaRecorder.stop();
  console.log("Recorded media.");
}

function drawTimestamp() {
  const now = new Date();
  const hours = now.getHours().toString().padStart(2, "0");
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const seconds = now.getSeconds().toString().padStart(2, "0");
  const milliseconds = now.getMilliseconds().toString().padStart(3, "0");

  const timestamp = `${hours}:${minutes}:${seconds}.${milliseconds}`;

  ctx.font = "20px Arial";
  ctx.fillStyle = "white";
  ctx.fillText(timestamp, 10, 30);
}

function captureFrame() {
  ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
  drawTimestamp();

  const frameData = canvas.toDataURL("image/png"); // フレームデータをBase64エンコード
  recordedBlobs.push(new Blob([frameData], { type: "image/png" }));

  requestAnimationFrame(captureFrame);
}

startBtn.addEventListener("click", () => {
  const constraints = {
    video: {
      width: 1280,
      height: 720
    }
  };

  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(mediaStream => {
      getLocalMediaStream(mediaStream);
      canvas.width = localVideo.videoWidth;
      canvas.height = localVideo.videoHeight;
      captureFrame();
    })
    .catch(handleLocalMediaStreamError);
});

recordBtn.addEventListener("click", () => {
  if (recordBtn.textContent === "録画開始") {
    startRecording();
  } else {
    stopRecording();
    recordBtn.textContent = "録画開始";
    playBtn.disabled = false;
    downloadBtn.disabled = false;
  }
});

playBtn.addEventListener("click", () => {
  const superBuffer = new Blob(recordedBlobs, { type: "video/webm" });
  recordedVideo.src = null;
  recordedVideo.srcObject = null;
  recordedVideo.src = window.URL.createObjectURL(superBuffer);
  recordedVideo.controls = true;
  recordedVideo.play();
});

downloadBtn.addEventListener("click", () => {
  const blob = new Blob(recordedBlobs, { type: "video/webm" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.style.display = "none";
  a.href = url;
  a.download = "rec.mp4";
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }, 100);
});

        // ページ読み込み時に実行
// document.addEventListener("DOMContentLoaded", () => {
//   const videoElement = document.getElementById("videoElement");
//   const canvas = document.getElementById("canvas");
//   const startRecordingButton = document.getElementById("startRecording");
//   const stopRecordingButton = document.getElementById("stopRecording");
//   const downloadLink = document.getElementById("downloadLink");
//   const mediaStreamConstraints = { video: true };

//   let mediaRecorder;
//   let recordedChunks = [];
//   let isRecording = false;

//   // カメラのストリームを取得してビデオ要素にセット
//   navigator.mediaDevices
//     .getUserMedia(mediaStreamConstraints)
//     .then((stream) => {
//       videoElement.srcObject = stream;
//     })
//     .catch((error) => {
//       console.error("カメラへのアクセスが拒否されました:", error);
//     });

//   // カメラの映像をキャンバスに描画し、タイムスタンプを追加
//   function captureFrame() {
//     const ctx = canvas.getContext("2d");
//     canvas.width = videoElement.videoWidth;
//     canvas.height = videoElement.videoHeight;
//     ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

//     const timestamp = new Date().getTime(); // タイムスタンプを取得
//     ctx.fillText(timestamp.toString(), 10, 20); // タイムスタンプを描画
//   }

//   // 録画開始ボタンのクリック時の処理
//   startRecordingButton.addEventListener("click", () => {
//     console.log("録画開始");
//     mediaRecorder = new MediaRecorder(videoElement.srcObject);
//     mediaRecorder.ondataavailable = handleDataAvailable;
//     mediaRecorder.start();
//     isRecording = true;
//   });

//   // 録画停止ボタンのクリック時の処理
//   stopRecordingButton.addEventListener("click", () => {
//     console.log("録画停止");
//     if (isRecording) {
//       mediaRecorder.stop();
//       isRecording = false;
//     }
//   });

//   // メディアデータが利用可能な場合の処理
//   function handleDataAvailable(event) {
//     if (event.data.size > 0) {
//       recordedChunks.push(event.data);
//     }
//   }

  // ダウンロードリンクの設定
//   mediaRecorder.onstop = () => {
//     const blob = new Blob(recordedChunks, { type: "video/webm" });
//     const url = URL.createObjectURL(blob);
//     downloadLink.href = url;
//     downloadLink.download = "recorded_video.webm";
//     downloadLink.style.display = "block";
//   };

  // タイムスタンプを含むフレームをキャプチャし、録画データに追加
//   mediaRecorder.ondataavailable = (e) => {
//     if (e.data.size > 0) {
//       recordedChunks.push(e.data);
//       captureFrame(); // タイムスタンプを含むフレームをキャプチャ
//     }
//   };
// });

        // const webcam = document.getElementById('webcam');
        // const canvas = document.getElementById('canvas');
        // const ctx = canvas.getContext('2d');
        // const frameArray = [];

        // // html2canvasライブラリをインポート
        // // const html2canvas = require('html2canvas');
        // // const JSZip = require('jszip');

        // // 新しいZipファイルを作成
        // // const zip = new JSZip();

        // // ウェブカメラから映像をキャプチャ
        // navigator.mediaDevices.getUserMedia({ video: true })
        //     .then(stream => {
        //         webcam.srcObject = stream;
        //     })
        //     .catch(error => {
        //         console.error('Error accessing webcam:', error);
        //     });

        // // タイムスタンプを描画
        // function drawTimestamp() {
        //     const now = new Date();
        //     const hours = now.getHours().toString().padStart(2, '0');
        //     const minutes = now.getMinutes().toString().padStart(2, '0');
        //     const seconds = now.getSeconds().toString().padStart(2, '0');
        //     const milliseconds = now.getMilliseconds().toString().padStart(3, '0');
            
        //     const timestamp = `${hours}:${minutes}:${seconds}.${milliseconds}`;
            
        //     ctx.font = '20px Arial';
        //     ctx.fillStyle = 'white';
        //     ctx.fillText(timestamp, 10, 30);
        // }

        // // キャンバスに映像を描画
        // function captureFrame() {
        //     ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
        //     drawTimestamp();

        //     const frameData = canvas.toDataURL('image/png');  // フレームデータをBase64エンコード
        //     frameArray.push(frameData);  // フレームデータを配列に格納

        //     // 次のフレームをキャプチャ
        //     requestAnimationFrame(captureFrame);
        // }

        // // 映像が読み込まれたらキャプチャ開始
        // webcam.addEventListener('play', () => {
        //     canvas.width = webcam.videoWidth;
        //     canvas.height = webcam.videoHeight;
        //     captureFrame();
        // });

        // function sendFrameData() {
        //     // POSTリクエストを送信して動画の順番データデータをサーバーに送信
        //     var xhr = new XMLHttpRequest();
        //     xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
        //     xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
        //     xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

        //     xhr.onload = function () {
        //         if (xhr.status === 200) {
        //             // レスポンスの処理
        //             console.log("サーバーレスポンス: " + xhr.responseText);
        //         }
        //     };

        //     frames = [];

        //     console.log("frameArraySize: " + frameArray.length);

        //     for (let i = 0; i < 3; i++) {
        //         frames.push(frameArray[i]);
        //     }

        //     var context = { 
        //         action: 'webcamera', 
        //         frames: frames,
        //     };
        //     var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
        //     xhr.send(data);
        // }

        // // ダウンロードボタンがクリックされたとき
        // // const downloadButton = document.getElementById('downloadButton');
        // // downloadButton.addEventListener('click', () => {
        // //     // Zipファイルに各フレームの画像を追加
        // //     for (let i = 0; i < frameArray.length; i++) {
        // //         zip.file(`frame_${i}.png`, frameArray[i].split(',')[1], { base64: true });
        // //     }

        // //     // Zipファイルを生成
        // //     zip.generateAsync({ type: 'blob' }).then(function (content) {
        // //         // ダウンロードリンクを作成
        // //         const a = document.createElement('a');
        // //         a.href = URL.createObjectURL(content);
        // //         a.download = 'frames.zip';

        // //         // ダウンロードリンクをクリックしてzipファイルをダウンロード
        // //         a.style.display = 'none';
        // //         document.body.appendChild(a);
        // //         a.click();
        // //         document.body.removeChild(a);
        // //     });
        // // });

        // document.getElementById('downloadLink').addEventListener('click', function() {
        //     console.log("zipダウンロード");
        //     // Zipファイルを生成
        //     const zip = new JSZip();

        //     // Zipファイルに各フレームの画像を追加
        //     for (let i = 0; i < frameArray.length; i++) {
        //         console.log(`add frame_${i}.png`);
        //         zip.file(`frame_${i}.png`, frameArray[i].split(',')[1], { base64: true });
        //     }

        //     // Zipファイルを生成し、ダウンロードする
        //     zip.generateAsync({ type: 'blob' }).then(function (content) {
        //         const a = document.createElement('a');
        //         a.href = URL.createObjectURL(content);
        //         a.download = 'frames.zip';

        //         // 作成したリンクを DOM に追加してクリックイベントをトリガー
        //         document.body.appendChild(a);
        //         a.click();
        //         document.body.removeChild(a);
        //     });
        // });

        // function downloadZip() {
        //     console.log("zipダウンロード");
        //     const zip = new JSZip();
        //      // Zipファイルに各フレームの画像を追加
        //      for (let i = 0; i < frameArray.length; i++) {
        //         console.log(`add frame_${i}.png`);
        //         zip.file(`frame_${i}.png`, frameArray[i].split(',')[1], { base64: true });
        //     }

        //     // Zipファイルを生成
        //     zip.generateAsync({ type: 'blob' }).then(function (content) {
        //         // ダウンロードリンクを作成
        //         const a = document.createElement('a');
        //         a.href = URL.createObjectURL(content);
        //         a.download = 'frames.zip';

        //         // ダウンロードリンクをクリックしてzipファイルをダウンロード
        //         a.style.display = 'none';
        //         document.body.appendChild(a);
        //         a.click();
        //         document.body.removeChild(a);
        //     });
        // }

        var player;

        var quiz_movie_ids;
        var quizIndex = 0;
        var currentMovieID = "";
        var person_id = "";

        const questionnaireTime = 10000; // (ms)
        const breakTime = 5000  // 問題間の休憩時間

        var isPlaying = false;

        // YouTube APIがロードされたときに実行されるコールバック関数
        function onYouTubeIframeAPIReady() {
            // player オブジェクトを生成
            console.log("YouTube APIが初期化されました。")

            // 現在のURLを取得
            var currentURL = window.location.href;

            // 正規表現を使用してperson_idの値を抽出
            var regex = /person_id=([^&]+)/;
            var match = currentURL.match(regex);

            // person_idの値を取得
            var personId = match && match[1];
            person_id = personId;
            // console.log("person_idの値は: " + person_id);

            createNewPlayer(true, true);
        }

        // ランダムな順番にした動画IDを生成
        function makeQuizMovieIDs() {
            // 例題
            // const quiz_movie_ex = 'JinLnLlAdew' // 仮置き（蚊）
            const quiz_movie_ex = '4t8JCicyYfc' // 仮置き（クイズノック）

            // 謎解き
            const quiz_movie_mystery = [
                // 'ekbPqltDYMQ',  // アーモンド
                // 'yF1QVXk8R3Q',  // いのしし
                // 'Xljgsas54CA',  // 赤身
                // 'zLm_ILEKJ7A',  // チューイングガム
                // 'CMOCBTYa8f0',  // マスカット
                // 'wqHQJsGpgV0',  // カッパ
                // 'IjdnudDMxnY',  // 太陽系
                '4t8JCicyYfc',  // クイズノック
                'qPHSalN8k0I',  // クイズノック
                'Ns8-e-5Ll6c',  // クイズノック
            ];

            // なぞなぞ
            const quiz_movie_riddle = [
                // 'JinLnLlAdew',  // 蚊  
                // '57VFZr9y6dA',  // いくら
                // '4TJ4u4K1pws',  // ソフトボール
                // 'pGXHxaH9osI',  // 不眠
                // 'XamRk58I1Pg',  // 森
                // 'p1Aw6_u0wmI',  // 視覚
                // 'DiSzWzk0Kq4',  // 119
                // 'aUR455d8oek',  // バトル
                '4t8JCicyYfc',  // クイズノック
                'qPHSalN8k0I',  // クイズノック
                'Ns8-e-5Ll6c',  // クイズノック
            ];

            var quiz_movie_ids = [];

            quiz_movie_ids.push(quiz_movie_ex);

            const randoms_mystery = makeRandomArray(0, quiz_movie_mystery.length - 1);
            for (i = 0; i < randoms_mystery.length; i++) {
                quiz_movie_ids.push(quiz_movie_mystery[randoms_mystery[i]]);
            }

            const randoms_riddle = makeRandomArray(0, quiz_movie_riddle.length - 1);
            for (i = 0; i < randoms_riddle.length; i++) {
                quiz_movie_ids.push(quiz_movie_riddle[randoms_riddle[i]]);
            }

            // POSTリクエストを送信して動画の順番データデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            // 動画のIDリストから例題のIDを除いたリストを生成
            // console.log("削除前： " + quiz_movie_ids);
            var copy_movie_ids = JSON.parse(JSON.stringify(quiz_movie_ids));
            copy_movie_ids.shift();
            // console.log("削除後： " + copy_movie_ids);

            var context = { 
                action: 'quiz_order', 
                randoms_mystery: randoms_mystery,
                randoms_riddle: randoms_riddle,
                movie_ids: copy_movie_ids, 
                person_id: person_id,
            };
            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);

            return quiz_movie_ids;
        }

        function makeRandomArray(min, max) {
            var randoms = [];
            for(i = min; i <= max; i++){
                while(true){
                    var tmp = randomInt(min, max);
                    if(!randoms.includes(tmp)){
                        randoms.push(tmp);
                        break;
                    }
                }
            }
            console.log("randoms: " + randoms);
            return randoms;
        }

        function randomInt(min, max){
            return Math.floor( Math.random() * (max - min + 1)) + min;
        }

        // 動画再生が終了したときに id=player の div 要素を削除する関数
        function removePlayer() {
            let playerContainer = document.getElementById("playerContainer");
            let playerDiv =  document.getElementById("player");
            if (playerContainer) {
                playerContainer.removeChild(playerDiv);
            }
        }

        // 新しいプレーヤーを生成する関数
        // exPlay -> true：例題動画の再生
        // firstPlay -> true : 例題または本番の1回目の再生
        function createNewPlayer(exPlay, firstPlay) {
            var playerContainer = document.getElementById("playerContainer");
            var playerDiv = document.createElement("div");
            playerDiv.id = "player";
            playerContainer.appendChild(playerDiv);

            if (player) {
                // 現在のプレーヤーが存在する場合、削除します
                player.destroy();
                // console.log("destroy player")
            }

            // 動画のIDリストを生成（例題の問題の時）
            if (exPlay) {
                quiz_movie_ids = makeQuizMovieIDs();
                console.log("quiz_movie_ids: " + quiz_movie_ids);
            }

            // console.log("videoID: " + quizIndex)
            currentMovieID = quiz_movie_ids[quizIndex]
            player = new YT.Player('player', {
                videoId: currentMovieID,  // 埋め込むYouTube動画のIDを指定
                playerVars: {
                    // 'controls': 0,  // コントロールを非表示にする
                    'disablekb': 1,  // キーボード操作を無効にする
                    'showinfo': 0,   // タイトルとアップロード者情報を非表示にする
                    'rel': 0,        // 関連動画を非表示にする
                    'autoplay': 0,   // 自動再生を有効にする
                    'playsinline': 1  // iOSデバイスでインライン再生を有効にする
                },
                events: {
                    'onReady': function(event) {
                        // event.target.playVideo();  // 動画を自動再生
                        if (!firstPlay) {
                            event.target.playVideo(); // 自動再生

                            console.log("動画の再生を開始：onReady")
                        } else {
                            console.log("プレーヤーの準備が完了しました。")
                        }
                    },
                    'onStateChange': function(event) {
                        // console.log("onStateChange createNewPlayer")
                        if (event.data == YT.PlayerState.PLAYING) {
                            // 動画クリックするごとに毎回実行される
                            console.log("動画の再生を開始：PLAYING");

                            if (!isPlaying) {
                                // 動画の再生時刻の保存をサーバーに要求
                                orderSaveDate('play')
                                isPlaying = true;
                            }

                        } else if (event.data === YT.PlayerState.PAUSED) {
                            // 動画が一時停止されたときに再度再生
                            event.target.playVideo();
                        } else if (event.data === YT.PlayerState.ENDED) {
                            console.log("動画の再生が終了しました");

                            // 動画の再生終了時刻の保存をサーバーに要求
                            orderSaveDate('ended')
                            isPlaying = false;

                            // 動画を非表示
                            removePlayer(); // id=player の div 要素を削除
                            var playerContainer = document.getElementById("playerContainer");
                            if (playerContainer) {
                                playerContainer.style.display = "none";
                            }

                            // 回答フォームを非表示
                            var quizForm = document.getElementById("quizForm");
                            if (quizForm) {
                                quizForm.style.display = "none";
                            }

                            // アンケートを表示
                            resetRadioButtons();
                            var questionnaire = document.getElementById("questionnaire");
                            if (questionnaire) {
                                questionnaire.style.display = "block";
                            }

                            // アンケートのプログレスバーを表示
                            var durationInSeconds = questionnaireTime / 1000; // 秒数を変数で指定
                            var progress = 0; // 現在の進捗（0%から100%）
                            var progressBar = document.getElementById("progress-bar");

                            var interval = setInterval(function() {
                                progress += 1;
                                progressBar.style.width = (progress / durationInSeconds * 100) + "%";
                                progressBar.textContent = Math.round((progress / durationInSeconds) * 100) + "%";

                                if (progress >= durationInSeconds) {
                                    clearInterval(interval); // タイマーを停止
                                }
                            }, 1000); // 1秒ごとに更新
                            // 動画再生が終了したときに新しいタブで指定リンクを開く
                            // window.open('https://docs.google.com/forms/d/e/1FAIpQLSdnFFQIqY782gk1XMCYFhWKdOMsMFPaYdxABGaFscjp2FaZyg/viewform?usp=sf_link', '_blank');

                            setTimeout(function() {
                                console.log(`アンケート：${questionnaireTime / 1000}秒経過しました`);
                                // アンケートを送信
                                submitForm('questionnaire');
                                // // 次の動画を再生
                                // playNextVideo('play');
                                console.log("アンケートを送信完了");
                            }, questionnaireTime);

                            setTimeout(function() {
                                console.log(`休憩：${breakTime / 1000}秒経過しました`);
                                // 次の動画を再生
                                playNextVideo('play');
                            }, breakTime + questionnaireTime);
                        }
                    }
                }
            });
        }        

        // 動画を再生する関数
        function playVideo(action, exPlay, firstPlay) {
            // 例題動画の再生
            if (exPlay) {
                // webカメラの映像を非表示
                // var webCamera = document.getElementById("webcameraContainer");
                // if (webCamera) {
                //     webCamera.style.display = "none";
                // }

                // 例題ボタンを非表示
                var exPlayButton = document.getElementById("exPlayButton");
                if (exPlayButton) {
                    exPlayButton.style.display = "none";
                }
            }

            // 本番の動画1回目の再生
            if (firstPlay) {
                // 再生ボタンを非表示
                var playButton = document.getElementById("playButton");
                if (playButton) {
                    playButton.style.display = "none";
                }
            }
            // console.log("quizIndex playVideo: " + quizIndex)
            if (quizIndex != 0) {
                if (player) {
                    player = null
                }
                if(player == null) {
                    // console.log("player is null")
                    // player オブジェクトが存在しない場合、新たに生成
                    if (exPlay) {
                        createNewPlayer(false, true);
                    } else {
                        createNewPlayer(false, false);
                    }
                    // console.log("createNewPlayer playVideo")
                }
            }

            // 回答フォームを表示
            var quizForm = document.getElementById("quizForm");
            if (quizForm) {
                quizForm.style.display = "block";
            }

            // 動画を表示して再生
            var playerContainer = document.getElementById("playerContainer");
            // var playButton = document.getElementById("playButton");
            if (playerContainer) {
                playerContainer.style.display = "block";
                // console.log("make movie playVideo")
                // playButton.style.display = "none";
                // console.log("player: ")
                // console.log(player)

                if(player) {
                    // console.log("playVideo")
                    player.playVideo();
                }         
            }
        }

        function playNextVideo(action) {
            if (quizIndex == 1) {
                // 例題の次の動画
                // 再生ボタンを表示
                // 再生ボタンを非表示
                var playButton = document.getElementById("playButton");
                if (playButton) {
                    playButton.style.display = "block";
                }

            } else if (quizIndex < quiz_movie_ids.length) {
                console.log("次の動画を再生");
                playVideo('play', false);
            } else {
                // webカメラの映像を表示
                var webCamera = document.getElementById("webcameraContainer");
                if (webCamera) {
                    webCamera.style.display = "block";
                }

                // ダウンロードリンクを作成
                var downloadLink = document.createElement("a");
                downloadLink.href = "/quiz/stop_recording/";
                downloadLink.download = "video.mp4";
                downloadLink.textContent = "動画をダウンロード";

                var webcameraContainer = document.getElementById("webcameraContainer");

                if (webcameraContainer) {
                    webcameraContainer.appendChild(downloadLink);
                }
            }
            // console.log("次の動画を再生完了");
        }

        function orderSaveDate(action) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function() {
                if (xhr.status === 200) {
                    if (action == 'play') {
                        console.log("再生開始時刻の保存が成功しました");
                    } else if(action == 'ended') {
                        console.log("再生終了時刻の保存が成功しました");

                        // quizIndexの値をインクリメント
                        var responseData = JSON.parse(xhr.responseText);
                        quizIndex = responseData.quizIndex;
                        // console.log("Received quizIndex: " + quizIndex);
                    }
                }
            };
            var context = { 
                action: action, 
                quizIndex: quizIndex,
                person_id: person_id,
                movie_id: currentMovieID,
            };
            var data = JSON.stringify(context);  // JSONデータとして識別子を送信
            xhr.send(data);
        }

        function sendAnswer(action) {
            // フォームの内容を取得
            var answer = document.getElementById("answer").value;
            // POSTリクエストを送信してデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie'  person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            context = {
                action: action,
                answer: answer,
                person_id: person_id,
                movie_id: currentMovieID,
            }

            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);
        }

        // フォーム送信
        function submitForm(action) {
            console.log("アンケートを送信");
            // アンケートの回答を取得
            var context = {
                action: action,
                q1: getRadioButtonValue("q1"),
                q2_que: getRadioButtonValue("q2_que"),
                q2_ans: getRadioButtonValue("q2_ans"),
                q3: getRadioButtonValue("q3"),
                q4: getRadioButtonValue("q4"),
                person_id: person_id,
                movie_id: currentMovieID,
            };

            // POSTリクエストを送信してデータをサーバーに送信
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "{% url 'quiz_movie' person_id=person_id %}", true);
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");  // JSONデータを送信することを指定

            xhr.onload = function () {
                if (xhr.status === 200) {
                    // レスポンスの処理（任意）
                    console.log("サーバーレスポンス: " + xhr.responseText);
                }
                // フォームをリセット
                var textForm = document.getElementById("answer");
                textForm.value = '';
            };

            var data = JSON.stringify(context);  // JSONデータとしてアクションと回答を送信
            xhr.send(data);

            // プログレスバーをリセット
            var progressBar = document.getElementById("progress-bar");
            progress = 0; // 進捗をリセット
            progressBar.style.width = "0%"; // プログレスバーの幅を初期化
            progressBar.textContent = "0%";

            // アンケートを非表示
            var questionnaire = document.getElementById("questionnaire");
            questionnaire.style.display = "none";
        }

        function getRadioButtonValue(name) {
            var radioButtons = document.querySelectorAll(`input[name=${name}]`);
            var selectedValue;

            for (var i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                    selectedValue = radioButtons[i].value;
                    break;
                }
            }
            // console.log("選択されたラジオボタンの値: " + selectedValue);

            if (selectedValue == undefined) {
                selectedValue = "undefined";
            }

            return selectedValue;
        }

        function resetRadioButtons() {
            // Q1
            resetRadioButtonCheck("q1_delight");
            resetRadioButtonCheck("q1_boredom");
            resetRadioButtonCheck("q1_confused");
            resetRadioButtonCheck("q1_frustration");
            resetRadioButtonCheck("q1_concentration");
            resetRadioButtonCheck("q1_neutral");

            // Q2-1
            resetRadioButtonCheck("q2_que_very_easy");
            resetRadioButtonCheck("q2_que_easy");
            resetRadioButtonCheck("q2_que_normal");
            resetRadioButtonCheck("q2_que_hard");
            resetRadioButtonCheck("q2_que_very_hard");
            // Q2-2
            resetRadioButtonCheck("q2_ans_very_easy");
            resetRadioButtonCheck("q2_ans_easy");
            resetRadioButtonCheck("q2_ans_normal");
            resetRadioButtonCheck("q2_ans_hard");
            resetRadioButtonCheck("q2_ans_very_hard");
    
            // Q3
            resetRadioButtonCheck("q3_helpful");
            resetRadioButtonCheck("q3_somewhat_helpful");
            resetRadioButtonCheck("q3_neutral");
            resetRadioButtonCheck("q3_not_helpful");
            resetRadioButtonCheck("q3_not_at_all_helpful");

            // Q4
            resetRadioButtonCheck("q4_zero");
            resetRadioButtonCheck("q4_one");
            resetRadioButtonCheck("q4_two");
            resetRadioButtonCheck("q4_three");
            resetRadioButtonCheck("q4_four");
        }

        function resetRadioButtonCheck(id) {
            const radioButton = document.getElementById(id);
            radioButton.checked = false;
        }

    </script>
</body>
</html>

